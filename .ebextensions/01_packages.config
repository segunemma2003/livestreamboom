packages:
  yum:
    git: []
    docker: []

option_settings:
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: "livestream_project.settings"
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
  aws:elasticbeanstalk:container:python:
    WSGIPath: "livestream_project.wsgi:application"
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: static
    /media: media
  aws:autoscaling:launchconfiguration:
    SecurityGroups: "default,livestream-sg"
  aws:ec2:vpc:
    Subnets: "subnet-12345678,subnet-87654321"
    ELBSubnets: "subnet-12345678,subnet-87654321"
    VPCId: "vpc-12345678"

container_commands:
  01_migrate:
    command: "source /var/app/venv/*/bin/activate && python3 manage.py migrate --noinput"
    leader_only: true
  02_collectstatic:
    command: "source /var/app/venv/*/bin/activate && python3 manage.py collectstatic --noinput"
  03_create_recordings_dir:
    command: "mkdir -p /var/recordings && chmod 755 /var/recordings"
  04_create_logs_dir:
    command: "mkdir -p /var/log/livestream && chmod 755 /var/log/livestream"

files:
  "/etc/httpd/conf.d/websocket.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
      ProxyPreserveHost On
      ProxyRequests Off
      
      # WebSocket proxy for Django Channels
      ProxyPass /ws/ ws://127.0.0.1:8000/ws/
      ProxyPassReverse /ws/ ws://127.0.0.1:8000/ws/
      
      # HTTP proxy
      ProxyPass / http://127.0.0.1:8000/
      ProxyPassReverse / http://127.0.0.1:8000/