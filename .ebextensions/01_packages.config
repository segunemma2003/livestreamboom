packages:
  yum:
    git: []
    docker: []

option_settings:
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: "livestream_project.settings_production"
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
  aws:elasticbeanstalk:container:python:
    WSGIPath: "livestream_project.wsgi:application"
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: static
    /media: media
  aws:autoscaling:launchconfiguration:
    SecurityGroups: "default,livestream-sg"
  aws:ec2:vpc:
    # Using your actual subnet IDs from multiple AZs for high availability
    Subnets: "subnet-045f33c2761a596b8,subnet-05070c64feb670898,subnet-071ab62fd38c83d96,subnet-04032130a539a1981"
    ELBSubnets: "subnet-045f33c2761a596b8,subnet-05070c64feb670898,subnet-071ab62fd38c83d96,subnet-04032130a539a1981"
    VPCId: "vpc-093d9a79b8c5a4ca5"
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 10
  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Unit: Percent
    UpperThreshold: 70
    LowerThreshold: 20

container_commands:
  01_migrate:
    command: "source /var/app/venv/*/bin/activate && python3 manage.py migrate --noinput"
    leader_only: true
  02_collectstatic:
    command: "source /var/app/venv/*/bin/activate && python3 manage.py collectstatic --noinput"
  03_create_directories:
    command: "mkdir -p /var/recordings /var/log/livestream && chmod 755 /var/recordings /var/log/livestream"
  04_create_superuser:
    command: "source /var/app/venv/*/bin/activate && python manage.py shell -c \"from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.filter(username='admin').exists() or User.objects.create_superuser('admin', 'admin@example.com', 'changeme')\""
    leader_only: true

files:
  "/etc/httpd/conf.d/websocket.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
      ProxyPreserveHost On
      ProxyRequests Off
      
      # WebSocket proxy for Django Channels
      ProxyPass /ws/ ws://127.0.0.1:8000/ws/
      ProxyPassReverse /ws/ ws://127.0.0.1:8000/ws/
      
      # HTTP proxy
      ProxyPass / http://127.0.0.1:8000/
      ProxyPassReverse / http://127.0.0.1:8000/
      
  "/opt/elasticbeanstalk/tasks/taillogs.d/django.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/logs/*.log